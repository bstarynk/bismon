% file appendix-bm.tex, which is \input from bismon-chariot-doc.tex
% see https://github.com/bstarynk/bismon for more about Bismon
\section{Appendix}
\label{sec:appendix}

\subsection{Building \texttt{bismon} from its source code}
\label{subsec:building-bismon}

We focus here on how to build \texttt{bismon} from its source code on
\href{http://debian.org/}{Debian}-like distributions running on
x86-64 computers, such as
\href{https://www.debian.org/releases/stable/}{Debian Buster 10.6}, or
\href{https://ubuntu.com/}{Ubuntu 20.04}, or
\href{https://linuxmint.com/}{Linux Mint 20}. Familiarity with the
command line is required\footnote{For example, the reader is expected
  of being able to build \href{https://www.gnu.org/software/make/}{GNU
    make} or \href{https://www.gnu.org/software/bash/}{GNU bash} from
  their source code.}, with \texttt{root} access (e.g. using
\texttt{sudo}).

The reader is expected to be authorized (by his/her management, if
that build is done professionally) to build \texttt{bismon} from its
source code and probably also some recent
\href{https://gcc.gnu.org/}{GCC} cross-compiler on his/her Linux workstation
and should budget several days of work for that.


\subsection{Prerequisites for building \texttt{bismon}}
\label{subsec:prereq-bismon}

The \texttt{bismon} source code is on
\href{https://github.com/bstarynk/bismon/}{\texttt{\textbf{github.com/bstarynk/bismon/}}}
and the reader is expected to be capable of getting that source code
on his/her Linux workstation. A possible command to retrieve that code
might be \texttt{git clone https://github.com/bstarynk/bismon.git} ;
you'll then obtain a \emph{fresh} \texttt{bismon/} subdirectory
containing the source code. About 100Mbytes of disk space (for less
than 2000 inodes) is required.

A recent \texttt{libonion} library\footnote{This is an open source
  library for web HTTP and HTTPS service. It is LGPL licensed.}
(version 0.8 at least) is required. Fetch \texttt{libonion}'s source
code from
\href{https://github.com/davidmoreno/onion}{\texttt{\textbf{github.com/davidmoreno/onion/}}}
and follow its build instructions: probably \texttt{mkdir \_build} then
\texttt{cd \_build} then \texttt{cmake ..} then \texttt{make} and at
last \texttt{sudo make install}. That \texttt{libonion} library needs
less than 25Mbytes of disk space,
\href{https://cmake.org}{\texttt{cmake}} and several libraries (in
particular support for \texttt{openssl}, \texttt{gcrypt},
\texttt{systemd}, \texttt{sqlite3}, \texttt{lzma}, \texttt{libicu},
\texttt{libpam}) to be built. Check and inspect your
\texttt{onion/version.h} header file\footnote{You might use
  \href{https://man7.org/linux/man-pages/man1/locate.1.html}{\texttt{locate(1)}}
  or
  \href{https://man7.org/linux/man-pages/man1/find.1.html}{\texttt{find(1)}}
  to find files on your Linux box. On \emph{my} Linux machine, that
  header file is in \texttt{/usr/local/include/onion/version.h} and
  comes from \emph{libonion}
  \href{https://github.com/davidmoreno/onion/commit/43128b03199518d4878074c311ff71ff0018aea8}{git
    commit \texttt{43128b031995}}....}, it should have some
\texttt{ONION\_VERSION} close to \texttt{0.8.150} at least.

The \href{https://www.gnu.org/software/readline/}{GNU readline}
(GPLv3+ licensed) library is required, at version 8. It is useful for
autocompletion abilities in interactive situations.

Ian Lance Taylor's
\href{https://github.com/ianlancetaylor/libbacktrace}{libbacktrace}
library is needed for backtraces on error and in warnings, and
possibly for future (generated) introspective code. This library takes
advantage of \href{https://en.wikipedia.org/wiki/DWARF}{DWARF}
debugging metadata in object files and executable, so it is advised to
compile every \emph{Bismon} source file (either handwritten or
generated) with \texttt{-g} (and possibly also \texttt{-O2} for
optimization) flag to \texttt{gcc} or \texttt{g++}.

\subsubsection{Naming conventions and source files organization for \texttt{bismon}}

\medskip

{\large \textbf{naming and coding conventions in hand-written \emph{C} code}}

\begin{itemize}

  \item \textbf{All} public
    \href{https://en.wikipedia.org/wiki/Executable_and_Linkable_Format}{ELF}
    \textbf{names of hand-written functions or global variables} (as
    known to
    \href{https://man7.org/linux/man-pages/man1/nm.1.html}{\texttt{nm(1)}},
    \href{https://man7.org/linux/man-pages/man1/objdump.1.html}{\texttt{objdump(1)}}
    or to
    \href{https://man7.org/linux/man-pages/man3/dlsym.3.html}{\texttt{dlsym(3)}}
    \textbf{are conventionally suffixed by}
           {\texttt{\textbf{\_BM}}}\,. For example, we have some
           \texttt{prime\_above\_BM} function giving some prime number
           above a given reasonable positive integer.

\item \textbf{We have conventional suffixes:} Our public
  \texttt{struct}-s are generally tagged with a name ending with
         {\texttt{\textbf{\_stBM}}}\,; Our \texttt{typedef}-ed types
         are suffixed with {\texttt{\textbf{\_tyBM}}}\,; usually their
         field names is globally unique and share a common prefix
         (e.g. in \texttt{struct parstoken\_stBM} field names all
         start with \texttt{tok}). Public signatures (useful for C
         function pointers) are suffixed with
         {\texttt{\textbf{\_sigBM}}}\, (for example, the
         initialization of generated modules is a C function of
         signature \texttt{moduleinit\_sigBM}\,). Most public
         \texttt{enum}-s have their name ending with
                {\texttt{\textbf{\_enBM}}}\, e.g. \texttt{space\_enBM}
                for space numbers.

              \item Preprocessor symbols or macros are in all capital
                ending with {\texttt{\textbf{\_BM}}}\,, notably the
                important \texttt{LOCALFRAME\_BM} variadic macro for
                local roots known to our garbage collector.
\end{itemize}

{\large \textbf{Hand-written \emp{C} code files}}

\begin{itemize}
  \item The header file \texttt{bismon.h} is our only public header file,
    and is \texttt{\#include}d everywhere. It includes system headers (e.g. \texttt{<unistd.h>} or \texttt{<pthread.h>}, and the following ``internal'' headers:
    \begin{enumerate}
      \item \texttt{cmacros_BM.h} is \texttt{\#define}-ing important
        global preprocessor macros, including \texttt{FATAL\_BM} for
        fatal errors, \texttt{LOCALFRAME\_BM} variadic macro for local
        roots, \texttt{DBGPRINTF\_BM} for debugging output,
        \texttt{WARNPRINTF\_BM} for warning messages,
        \texttt{INFOPRINTF\_BM} for informational messages, etc... The
        \texttt{ROUTINEOBJNAME\_BM} macro is giving the routine name of
        a given object id.

      \item \texttt{id\_BM.h} is implementing our object ids.

      \item \texttt{types\_BM.h} is defining our global types,
        \texttt{struct}-s, etc... Notice the \texttt{value\_tyBM}
        opaque type (a \texttt{void*} pointer) for Bismon values.

        \item \texttt{global\_BM.h} is declaring our \texttt{extern}al
          global data, some of which is generated.
        \item \texttt{fundecl\_BM.h} is declaring our global
          hand-written functions. Some of them are \texttt{static
            inline} for efficiency reasons (for example
          \texttt{elapsedtime\_BM} returning the elapsed clock time as
          a \texttt{double} number in seconds, or \texttt{valhash\_BM}
          to compute the hash code of a Bismon value.

        \item \texttt{inline\_BM.h} is implementing our global \texttt{static
            inline} functions.
    \end{enumerate}

  \item \texttt{agenda\_BM.c} is implementing our agenda
    \index{agenda} with tasklets \index{tasklet} (see \S
    \ref{subsec:multithreadist} above).

  \item \texttt{allocgc\_BM.c} is implementing low-level memory
    allocation and garbage collector \index{garbage collector} (see \S
    \ref{subsec:gcvalobj} above).
  
  \item \texttt{assoc\_BM.c} is implementing associative lists and
    tables, \index{object} \index{attribute} \index{association} in
    particular for object attributes.

  \item The \texttt{code\_BM.c} file contains many Bismon routines for
    \index{closure} closures.

  \item The \texttt{dump\_BM.c} file is implementing the \index{dump} dump of the
      persistent store. \index{persistence} \index{store} See \S
      \ref{subsec:persistence}.

  \item The \texttt{emitcode\_BM.c} file contains many Bismon routines
    for \index{emission} emission or \index{generation} of C code in
    \index{module} modules.
  \item The \texttt{engine\_BM.c} file is related to \index{tasklet}-s.

  \item \texttt{gencode\_BM.c} is related to C code generation.

  \item \texttt{id\_BM.c} implements objid support.

  \item \texttt{jsonjansson\_BM.c} is for JSON values.

  \item \texttt{list\_BM.c} is for list values.

  \item \texttt{load\_BM.c} is for loading the persistent store
  \index{load} \index{persistence}.

  \item \texttt{main\_BM.c} has the \texttt{main} function and support functions (fatal errors, etc...).

  \item \texttt{node\_BM.c} implements node values.

  \item \texttt{object\_BM.c} implements objects.

  \item \texttt{parser\_BM.c} implements the parser.

  \item \texttt{primes\_BM.c} contains an array of prime numbers and related utilities.

  \item \texttt{scalar\_BM.c} implements scalar values (strings, boxed doubles).

  \item \texttt{sequence\_BM.c} implements sets and tuples.

  \item \texttt{user\_BM.c} relates to reifications of contributors and
  users.

  \item \texttt{misc\_BM.cc} is a \textbf{C++} file, to take advantage of some standard C++ containers.
\end{itemize}

{\large \textbf{Generated \emp{C} code files}}

{\textcolor{red}{\large @@TO BE WRITTEN}}
