% file appendix-bm.tex, which is \input from bismon-chariot-doc.tex
% see https://github.com/bstarynk/bismon for more about Bismon
\section*{Appendix}
\label{sec:appendix}

\subsection{Building \texttt{bismon} from its source code}
\label{subsec:building-bismon}

We focus here on how to build \texttt{bismon} from its source code on
\href{http://debian.org/}{Debian}-like distributions running on x86-64
computers, such as
\href{https://www.debian.org/releases/stable/}{Debian Buster 10.6}, or
\href{https://ubuntu.com/}{Ubuntu 20.04}, or
\href{https://linuxmint.com/}{Linux Mint 20}. Familiarity with the
command line is required\footnote{For example, the reader is expected
  of being able to build \href{https://www.gnu.org/software/make/}{GNU
    make} or \href{https://www.gnu.org/software/bash/}{GNU bash} from
  their source code.}, with \texttt{root} access (e.g. using
\texttt{sudo}). Fluency with \href{https://git-scm.com/}{\texttt{git}}
is expected, and it is strongly advised to \texttt{git commit} every
few hours (including your persistent store, when \texttt{bismon} is
\emph{not running}).

The reader is expected to be authorized (by his/her management, if
that build is done professionally) to build \texttt{bismon} from its
source code and probably also some recent
\href{https://gcc.gnu.org/}{GCC} cross-compiler on his/her Linux workstation
and should budget several days of work for that.


{\large Be aware that \textbf{\texttt{bismon} requires specifically some
  \href{https://gcc.gnu.org/gcc-10/}{GCC 10} compiler} and won't work
  with e.g. a GCC 9 compiler.}

\subsection{Prerequisites for building \texttt{bismon}}
\label{subsec:prereq-bismon}

The \texttt{bismon} source code is on
\href{https://github.com/bstarynk/bismon/}{\texttt{\textbf{github.com/bstarynk/bismon/}}}
and the reader is expected to be capable of getting that source code
on his/her Linux workstation. A possible command to retrieve that code
might be \texttt{git clone https://github.com/bstarynk/bismon.git} ;
you'll then obtain a \emph{fresh} \texttt{bismon/} subdirectory
containing the source code. About 100Mbytes of disk space (for less
than 2000 inodes) is required.

A recent \texttt{libonion} library\footnote{This is an open source
  library for web HTTP and HTTPS service. It is LGPL licensed.}
(version 0.8 at least) is required. Fetch \texttt{libonion}'s source
code from
\href{https://github.com/davidmoreno/onion}{\texttt{\textbf{github.com/davidmoreno/onion/}}}
and follow its build instructions: probably \texttt{mkdir \_build} then
\texttt{cd \_build} then \texttt{cmake ..} then \texttt{make} and at
last \texttt{sudo make install}. That \texttt{libonion} library needs
less than 25Mbytes of disk space,
\href{https://cmake.org}{\texttt{cmake}} and several libraries (in
particular support for \texttt{openssl}, \texttt{gcrypt},
\texttt{systemd}, \texttt{sqlite3}, \texttt{lzma}, \texttt{libicu},
\texttt{libpam}) to be built. Check and inspect your
\texttt{onion/version.h} header file\footnote{You might use
  \href{https://man7.org/linux/man-pages/man1/locate.1.html}{\texttt{locate(1)}}
  or
  \href{https://man7.org/linux/man-pages/man1/find.1.html}{\texttt{find(1)}}
  to find files on your Linux box. On \emph{my} Linux machine, that
  header file is in \texttt{/usr/local/include/onion/version.h} and
  comes from \emph{libonion}
  \href{https://github.com/davidmoreno/onion/commit/43128b03199518d4878074c311ff71ff0018aea8}{git
    commit \texttt{43128b031995}}....}, it should have some
\texttt{ONION\_VERSION} close to \texttt{0.8.150} at least.

The \href{https://www.gnu.org/software/readline/}{GNU readline}
(GPLv3+ licensed) library is required, at version 8. It is useful for
autocompletion abilities in interactive situations.

Ian Lance Taylor's
\href{https://github.com/ianlancetaylor/libbacktrace}{libbacktrace}
library is needed for backtraces on error and in warnings, and
possibly for future (generated) introspective code. This library takes
advantage of \href{https://en.wikipedia.org/wiki/DWARF}{DWARF}
debugging metadata in object files and executable, so it is advised to
compile every \emph{Bismon} source file (either handwritten or
generated) with \texttt{-g} (and possibly also \texttt{-O2} for
optimization) flag to \texttt{gcc} or \texttt{g++}.


The \emph{Bismon} project \index{build!automation} uses two \href{https://en.wikipedia.org/wiki/Build_automation}{build automation} tools:

\begin{itemize}

\item \href{https://www.gnu.org/software/make/}{GNU \texttt{make}},
  version 4.2 at least. Our hand-written \texttt{GNUmakefile} is
  driving it. You need to run \texttt{make} commands to build
  \texttt{bismon}.

\item
  The \href{https://ninja-build.org/}{\texttt{ninja}} build automation
  tool (version 1.10 at least), is internally used (and could be
  started by our \texttt{GNUmakefile}) to compile and link the
  \texttt{bismon} executable. Its configuration file
  \texttt{ninja.build} is generated by some \texttt{make} command.

\end{itemize}
  
\subsubsection{File naming conventions in \texttt{bismon}}

By our conventions, files \index{file} \index{naming!conventions}
whose base name\footnote{In the sense of the
\href{https://man7.org/linux/man-pages/man1/basename.1.html}{\texttt{basename(1)}}
command applied to the file path.} start with a single underscore
(that is, a \textbf{\texttt{\_}} character) are generated: for example
\texttt{\_bismon-config.mk} and \texttt{\_bm\_config.h},
etc... However, some of them (e.g. \texttt{\_bismon-constants.c}...)
need to be kept, backed-up and version controlled but would be
regenerated by running
\index{make@\texttt{make}} \index{redump@\texttt{redump}}
\index{bismon-config@\texttt{\_bismon-config.mk}}
\index{bm-config@\texttt{\_bm\_config.h}}
\texttt{make redump}.

File names whose base name start with two underscores, such as
\texttt{\_\_timestamp.c}, are temporary and can be removed. They would
be removed by running \texttt{make clean} or \texttt{make
  distclean}.
\index{clean@\texttt{clean}} 
\index{distclean@\texttt{distclean}} Of course,
\href{https://en.wikipedia.org/wiki/Object_file}{object file}s
\index{object!file}
(suffixed \texttt{.o}) and
\href{https://en.wikipedia.org/wiki/Library_(computing)#Shared_libraries}{shared
  libraries} (suffixed \texttt{.so}, see
\index{library!shared}
\cite{Drepper:2011:sharedlib}) are also temporary, and could be
removed then regenerated. Some of these (in particular under
\texttt{modubin/} directory) are
\index{modubin@\texttt{modubin/}} 
\href{https://man7.org/linux/man-pages/man3/dlopen.3.html}{\texttt{dlopen(3)}}-ed.

The main executable is named \texttt{bismon}. But
\texttt{BM\_makeconst} and \texttt{BISMON-config} are auxiliary
metaprograms (generating C or C++ code). All three are
\href{https://en.wikipedia.org/wiki/Executable_and_Linkable_Format}{ELF}
executables.

\medskip

\subsubsection{Naming conventions and source files organization for \texttt{bismon}}

\medskip

{\large \textbf{naming and coding conventions in hand-written \emph{C} code}}

\begin{itemize}

  \item \textbf{All} public
    \href{https://en.wikipedia.org/wiki/Executable_and_Linkable_Format}{ELF}
    \index{ELF}
    \textbf{names of hand-written functions or global variables} (as
    known to
    \href{https://man7.org/linux/man-pages/man1/nm.1.html}{\texttt{nm(1)}},
    \href{https://man7.org/linux/man-pages/man1/objdump.1.html}{\texttt{objdump(1)}}
    or to
    \href{https://man7.org/linux/man-pages/man3/dlsym.3.html}{\texttt{dlsym(3)}}
    \textbf{are conventionally suffixed by}
           {\texttt{\textbf{\_BM}}}\,. For example, we have some
           \texttt{prime\_above\_BM} function giving some prime number
           above a given reasonable positive integer.

         \item \textbf{We have conventional suffixes:} Our public
           \index{suffix!file} \texttt{struct}-s are generally tagged
           with a name ending with {\texttt{\textbf{\_stBM}}}\,; Our
           \texttt{typedef}-ed types are suffixed with
                  {\texttt{\textbf{\_tyBM}}}\,; usually their field
                  names is globally unique and share a common prefix
                  (e.g. in \texttt{struct parstoken\_stBM} field names
                  all start with \texttt{tok}). Public signatures
                  (useful for C function pointers) are suffixed with
                  {\texttt{\textbf{\_sigBM}}}\, (for example, the
                  initialization of generated modules is a C function
                  of signature \texttt{moduleinit\_sigBM}\,). Most
                  public \texttt{enum}-s have their name ending with
                  {\texttt{\textbf{\_enBM}}}\,
                  e.g. \texttt{space\_enBM} for space numbers.

              \item Preprocessor symbols or macros are in all capital
                ending with {\texttt{\textbf{\_BM}}}\,, notably the
                important \texttt{LOCALFRAME\_BM} variadic macro for
                \index{localframe-bm@\texttt{LOCALFRAME\_BM} macro}
                local roots known to our garbage collector.
\end{itemize}

{\large \textbf{Hand-written \emph{C} code files}}

\begin{itemize}
  \item The header file \texttt{bismon.h} is our
    \index{bismon-h@\texttt{bismon.h} header} only public header file,
    and is \texttt{\#include}d everywhere. It includes system headers
    (e.g. \texttt{<unistd.h>} or \texttt{<pthread.h>}, and the
    following ``internal'' headers:
    \begin{enumerate}
      \item \texttt{cmacros\_BM.h} is \texttt{\#define}-ing important
        \index{cmacro-h@\texttt{cmacros\_BM.h} header} global
        preprocessor macros, including \texttt{FATAL\_BM} for fatal
        errors, \texttt{LOCALFRAME\_BM} variadic macro for local
        roots, \texttt{DBGPRINTF\_BM} for debugging output,
        \texttt{WARNPRINTF\_BM} for warning messages,
        \texttt{INFOPRINTF\_BM} for informational messages, etc... The
        \texttt{ROUTINEOBJNAME\_BM} macro
        \index{fatal-bm@\texttt{FATAL\_BM} macro}
        \index{dbgprintf-bm@\texttt{DBGPRINTF\_BM} macro}
        \index{warnprintf-bm@\texttt{WARNPRINTF\_BM} macro}
        \index{infoprintf-bm@\texttt{INFOPRINTF\_BM} macro}
        \index{routineobjectname-bm@\texttt{ROUTINEOBJNAME\_BM} macro}
        is giving the routine name of \index{objid} a given
        \textit{objid}.

      \item \texttt{id\_BM.h} is implementing
        \index{id-bm@\texttt{id\_BM.h} header} our object ids.

      \item \texttt{types\_BM.h} is defining our global types,
        \index{type-bm@\texttt{types\_BM.h} header} 
        \index{value-tybm@\texttt{value\_tyBM} opaque types} 
        \texttt{struct}-s, etc... Notice the \texttt{value\_tyBM}
        opaque type (a \texttt{void*} pointer) for Bismon values.

        \item \texttt{global\_BM.h} is declaring our \texttt{extern}al
          \index{global-bm@\texttt{global\_BM.h} header} global data,
          some of which is generated. \index{data!global}
        \item \texttt{fundecl\_BM.h} is declaring our global
          \index{fundecl-bm@\texttt{fundecl\_BM.h} header}
          \index{function} hand-written functions. Some of them are
          \texttt{static inline} for efficiency reasons (for example
          \index{elapsertime-bm@\texttt{elapsedtime\_BM.h} function}
          \index{valhash-bm@\texttt{valhash\_BM} function}
          \index{time!elapsed} \index{hash!of values}
          \texttt{elapsedtime\_BM} returning the elapsed clock time as
          a \texttt{double} number in seconds, or \texttt{valhash\_BM}
          to compute the hash code of a Bismon value.

        \item \texttt{inline\_BM.h} is implementing our global \texttt{static
            inline} functions.
          \index{inline-bm@\texttt{inline\_BM.h} header}
          \index{function!inline}
    \end{enumerate}

  \item \texttt{agenda\_BM.c} is implementing our agenda
    \index{agenda} with tasklets \index{tasklet} (see \S
    \ref{subsec:multithreadist} above).
          \index{agenda-bm@\texttt{agenda\_BM.c} file}

  \item \texttt{allocgc\_BM.c} is implementing low-level memory
          \index{allocgc-bm@\texttt{allocgc\_BM.c} file}
    allocation and garbage collector \index{garbage collector} (see \S
    \ref{subsec:gcvalobj} above).
  
  \item \texttt{assoc\_BM.c} is implementing associative lists and
          \index{assoc-bm@\texttt{assoc\_BM.c} file} \index{list!associative}
    tables, \index{object} \index{attribute} \index{association} in
    particular for object attributes.

  \item The \texttt{code\_BM.c} file contains many Bismon routines for
          \index{code-bm@\texttt{code\_BM.c} file} \index{routine}
    \index{closure} closures.

  \item The \texttt{dump\_BM.c} file is implementing the \index{dump} dump of the
    persistent store. \index{persistence} \index{store} See \S
    \index{dump-bm@\texttt{dump\_BM.c} file}
      \ref{subsec:persistence}.

  \item The \texttt{emitcode\_BM.c} file contains many Bismon routines
    for \index{emission} emission or \index{generation} of C code in
    \index{emitcode-bm@\texttt{emitcode\_BM.c} file}
    \index{module} modules.

  \item The \texttt{engine\_BM.c} file is related to \index{tasklet} tasklets 
    \index{engine-bm@\texttt{engine\_BM.c} file} in the agenda (see \S
    \ref{subsec:multithreadist} above).

  \item \texttt{gencode\_BM.c} is related
    \index{gencode-bm@\texttt{gencode\_BM.c} file} to C code
    generation. \index{code!generation} \index{generation!of code}

  \item \texttt{id\_BM.c} implements objid \index{objid}
    \index{id-bm@\texttt{id\_BM.c} file} support.

  \item \texttt{jsonjansson\_BM.c} is for JSON \index{JSON}
    \index{jsonjansson-bm@\texttt{jsonjansson\_BM.c} file} support.
    values.

  \item \texttt{list\_BM.c} is for list \index{value!list}
    \index{list-bm@\texttt{list\_BM.c} file}  values.

  \item \texttt{load\_BM.c} is for loading the persistent store
    \index{load-bm@\texttt{load\_BM.c} file} 
  \index{load} \index{persistence}.

  \item \texttt{main\_BM.c} has the \texttt{main} function 
    \index{main-bm@\texttt{main\_BM.c} file} and support functions (fatal errors, etc...).

  \item \texttt{node\_BM.c} implements node values. \index{node-bm@\texttt{node\_BM.c} file}
    \index{value!node}

  \item \texttt{object\_BM.c} implements
    objects. \index{object-bm@\texttt{object\_BM.c} file}
    \index{object} \index{value!object}

  \item \texttt{parser\_BM.c} implements the parser
    \index{parser-bm@\texttt{parser\_BM.c} file} with callbacks
    \index{callback!parser}

  \item \texttt{primes\_BM.c} contains an array of prime numbers,
    \index{primes-bm@\texttt{primes\_BM.c} file} and related
    utilities. They could be useful in hash tables \index{hash table}
    and in some hash functions. In several cases,
    \href{https://en.wikipedia.org/wiki/Flexible_array_member}{flexible
      array members} inside \textsc{Bismon} are allocated with a prime
    number size. \index{prime} \index{member!flexible array}
    \index{flexible-array@flexible array member}

  \item \texttt{scalar\_BM.c} implements scalar values
    \index{value!string} \index{string} \index{double!boxed}
    \index{value!double}
    numbers. \index{scalar-bm@\texttt{scalar\_BM.c} file} (strings,
    boxed doubles).

  \item \texttt{sequence\_BM.c} implements sets and
    tuples.\index{sequence-bm@\texttt{sequence\_BM.c} file}

  \item \texttt{user\_BM.c} relates
    \index{user-bm@\texttt{user\_BM.c} file} to reifications of
    contributors and \index{contributor} users.

  \item \texttt{misc\_BM.cc} is a \textbf{C++} file,
    \index{misc-bm@\texttt{misc\_BM.cc} file} to take advantage of
    some standard C++ \index{C++} \index{container!C++} containers.
\end{itemize}

{\large \textbf{The persistent store}}

The persistent data (see \S \ref{sec:datapersist} above) sits in files
\index{persistent!store} \index{store!persistent}
\index{store-bm@\texttt{store*.bmon} files} \texttt{store*.bmon}
(using
\href{https://man7.org/linux/man-pages/man7/glob.7.html}{\texttt{glob(7)}}
notation); more precisely

\begin{itemize}

\item \texttt{store1.bmon} is for predefined objects. The header file
  \index{genbm-predef@\texttt{genbm-predef} file}
  \texttt{genbm\_predef.h} is generated from them at dump time.

\item \texttt{store2.bmon} contains the global object space. Several
  global objects describe modules whose C code is generated (e.g. at
  dump time) \index{dump} \index{module} under sub-directory
  \index{modules-dir@\texttt{modules/} directory}
  \textbf{\texttt{modules/}}\,.

\item other \texttt{store\textcolor{blue}{\textbf{\textit{i}}}.bmon}
  textual files contain\footnote{So there cannot be any
    \texttt{store0.bmon} file, since space 0 is for transient objects
    which are not dumped.}  objects in space ranked $i$ \ldots. Notice
  that all these files are both loaded and dumped, and should be
  backed-up (like the \textbf{\texttt{modules/}}\, directory)
  regularily.

\end{itemize}

These \emph{generated} textual
  \index{storei-bm@\texttt{store\textit{i}.bmon} files}
\texttt{store\textcolor{blue}{\textit{\textbf{i}}}.bmon} \emph{files}
should be \emph{version controlled} by the
\index{git@\texttt{git}}
\href{https://git-scm.com/}{\texttt{git}} tool. You might use the \texttt{make
  redump} command to regenerate the persistent store and the modules,
and it is advised\footnote{Once \texttt{make redump} fails, the
  persistent store is inconsistent and corrupted. This should not
  happen, but when it does, use
  \href{https://git-scm.com/docs/git-bisect}{\texttt{git bisect}} to
  find the latest consistent state of your \textit{Bismon} repository.}
to run it daily.
  
\subsubsection{Generators and meta-programs in \texttt{bismon}}

\textcolor{brown}{\textbf{Generating code is one of the core ideas of \textsc{Bismon}}}. Such code
generation happens both at build time and at run time. The generated
code is usually some C file\footnote{With additional funding and more
time, we could have used
\href{https://gcc.gnu.org/onlinedocs/jit/}{\texttt{libgccjit}} to
generate directly some \texttt{*.so} shared object.}.

At build time, two meta-programs are involved; each of them has a
single handwritten C++ source code file:

\begin{itemize}
  \item \texttt{BISMON-config}
    \index{bismon-config@\texttt{BISMON-config} metaprogram} is
    querying some parameters from the user (that is the Linux sysadmin
    installing \texttt{bismon}) and generates some C++ files.

  \item \texttt{BM\_makeconst}
    \index{bm-makeconst@\texttt{BM\_makeconst} metaprogram} is usually
    scanning some handwritten C file (for example, our
    \texttt{engine\_BM.c} file, etc...)  and producing some headers or
    utility files.
\end{itemize}

But once the \texttt{bismon} executable exists, the above metaprograms
are not useful anymore.

At run time, the \texttt{bismon} executable is routinely generating C
or C++ code. Some C code (under the \textbf{\texttt{modules/}}\,
directory) is generated to extend the behevior of \texttt{bismon}
itself : the generated C code is compiled, and the resulting shared
object is
\href{https://man7.org/linux/man-pages/man3/dlopen.3.html}{\texttt{dlopen(3)}}-ed
but never\footnote{Not \texttt{dlclose}-ing is of course some kind of
\href{https://en.wikipedia.org/wiki/Memory_leak}{memory leak}, since
the \href{https://en.wikipedia.org/wiki/Virtual_address_space}{virtual
  address space} of the process running \texttt{bismon} is never
shrinking.. This explains why the \texttt{bismon} process should be
restarted at least daily.  Our
\href{https://github.com/bstarynk/misc-basile/blob/master/manydl.c}{\texttt{manydl.c}}
program demonstrates that
\href{https://man7.org/linux/man-pages/man3/dlopen.3.html}{\texttt{dlopen(3)}}-ing
many thousands of times is practically possible on modern
\textsc{Linux} workstations.}
\href{https://man7.org/linux/man-pages/man3/dlclose.3.html}{\texttt{dlclose(3)}}-ed.

{\textcolor{red}{\large @@TO BE WRITTEN}}
